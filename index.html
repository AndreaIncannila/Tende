<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MP TENDE — Calcolatore taglio (L×H)</title>
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#2FD07B">
  <link rel="icon" href="icons/icon-192.png">
  <style>
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:#0b0c0e;color:#e6edf3}
    main{max-width:1040px;margin:32px auto;padding:0 16px}
    h1{font-size:20px;margin:0}
    small{color:#9aa4b2}
    .card{background:#15181c;border:1px solid #262b33;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
    .head{padding:16px 18px;border-bottom:1px solid #262b33;display:flex;gap:12px;align-items:center}
    .logo{height:56px}
    .grid{display:grid;gap:16px;padding:16px}
    @media(min-width:980px){.grid{grid-template-columns:1.05fr .95fr}}
    .panel{background:#0f1115;border:1px solid #232831;border-radius:12px;padding:14px}
    label{display:block;font-size:12px;color:#9aa4b2;margin:0 0 6px}
    input,select,button{width:100%;padding:12px;border-radius:10px;border:1px solid #2a303a;background:#0c0f14;color:#e6edf3;font-size:15px}
    button{cursor:pointer}
    .btn{background:linear-gradient(180deg,#38d485,#2fb36b);border:none;font-weight:600}
    .btn-ghost{background:#12151a}
    .btn-icon{width:auto;padding:8px 10px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px 12px}
    th{color:#9aa4b2;font-size:12px;letter-spacing:.04em;text-transform:uppercase}
    tr{background:#0f1115;border:1px solid #232831}
    tr td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tr td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .muted{color:#9aa4b2}
    .row{display:grid;gap:10px}
    @media(min-width:560px){.row{grid-template-columns:1fr 1fr}}
    details{margin-top:10px}
    code{background:#0b1118;padding:2px 6px;border-radius:6px;border:1px solid #1d2631}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap}
    .danger{background:#2b1216;border-color:#4a1e22}
    .warn{background:#2a220f;border-color:#4a3b1e}
    .pill{display:inline-block;font-size:11px;padding:3px 8px;border-radius:999px;background:#15212c;border:1px solid #223142;color:#9fb2c7}
    .editor-table{border:1px dashed #2b3440;border-radius:10px;padding:10px}
    .editor-row{display:grid;grid-template-columns:1.1fr 1fr auto auto auto;gap:8px;margin-bottom:8px;align-items:center}
    .editor-row input{width:100%}
    .icon-btn{border:1px solid #2a303a;background:#10141a;border-radius:8px;padding:8px 10px}
    .icon-btn:disabled{opacity:.5;cursor:not-allowed}
    #status{margin:10px 0;padding:10px;border:1px solid #2a303a;border-radius:10px;background:#0f1216;color:#cbd5e1;font-size:13px;white-space:pre-wrap}
  </style>
</head>
<body>
  <main class="card">
    <div class="head">
      <img src="logo-header.png" alt="MP TENDE" class="logo" />
      <div>
        <h1>MP TENDE — Calcolatore taglio (L × H)</h1>
        <small>Inserisci larghezza e altezza in centimetri, scegli/gestisci il modello e premi <b>Calcola</b>.</small>
      </div>
    </div>

    <div class="grid">
      <section class="panel">
        <div class="row">
          <div>
            <label for="model">Modello</label>
            <select id="model"></select>
          </div>
          <div>
            <label>&nbsp;</label>
            <div class="toolbar">
              <button id="btnAddModel" class="btn">Aggiungi modello</button>
              <button id="btnDeleteModel" class="danger">Elimina modello</button>
            </div>
            <small class="muted">I modelli sono salvati in locale (<code>localStorage</code>). Funziona anche offline.</small>
          </div>
        </div>

        <div id="status" style="display:none"></div>

        <div class="row" style="margin-top:8px">
          <div>
            <label for="L">Larghezza (L) [cm]</label>
            <input id="L" type="number" step="0.1" placeholder="es. 400" />
          </div>
          <div>
            <label for="H">Altezza (H) [cm]</label>
            <input id="H" type="number" step="0.1" placeholder="es. 260" />
          </div>
        </div>

        <div class="row" style="margin-top:10px">
          <button id="calc" class="btn">Calcola</button>
          <button id="reset">Reset</button>
        </div>

        <details open>
          <summary><b>Avanzate</b>: righe e formule del modello</summary>
          <small class="muted">Ogni riga ha un <b>Nome</b> e una <b>Formula</b> (usa <code>L</code> e <code>H</code>, es. <code>L - 12</code>). Costanti in centimetri.</small>
          <div id="editor" class="editor-table" style="margin-top:10px"></div>
          <div class="toolbar" style="margin-top:8px">
            <button id="addRow" class="btn-ghost">+ Aggiungi riga</button>
            <button id="save" class="btn">Salva formule nel modello</button>
            <button id="exportModels" class="warn">Esporta modelli</button>
            <label class="pill" for="importFile">Importa JSON</label>
            <input id="importFile" type="file" accept="application/json" style="display:none" />
          </div>
        </details>
      </section>

      <section class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <small class="muted" id="unitPill">Unità: cm</small>
          <small class="muted" id="modelBadge"></small>
        </div>
        <table>
          <thead>
            <tr><th>Voce</th><th>Formula</th><th>Risultato</th></tr>
          </thead>
        <tbody id="out"><tr><td colspan="3" class="muted">Inserisci L e H e premi Calcola.</td></tr></tbody>
        </table>
      </section>
    </div>
  </main>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js').catch(console.error);
      });
    }
  </script>

  <script>
    (function(){
      var DEFAULT_MODELS = {
        "MAGIKA": {
          items: [
            { label: "Rullo avvolgitore", expr: "L - 12" },
            { label: "Terminale", expr: "L - 13.7" },
            { label: "Barra frangivento", expr: "L - 15" },
            { label: "Larghezza telo", expr: "L - 14" },
            { label: "Altezza telo", expr: "H + 50" }
          ]
        }
      };

      var STORAGE_KEY = "mp-tende-modelli-cm";

      function showStatus(msg){
        var box = document.getElementById('status');
        box.style.display = 'block';
        box.textContent = msg;
      }
      function clearStatus(){
        var box = document.getElementById('status');
        box.style.display = 'none';
        box.textContent = '';
      }

      function normalizeModel(m){
        if(!m) return {items:[]};
        if(m.items && typeof m.items.push === 'function') return m;
        var items = [];
        if(m.formulas){
          var map = m.formulas;
          if(map.rullo) items.push({label: "Rullo avvolgitore", expr: map.rullo});
          if(map.terminale) items.push({label: "Terminale", expr: map.terminale});
          if(map.frangivento) items.push({label: "Barra frangivento", expr: map.frangivento});
          if(map.larghezza_telo) items.push({label: "Larghezza telo", expr: map.larghezza_telo});
          if(map.altezza_telo) items.push({label: "Altezza telo", expr: map.altezza_telo});
        }
        return { items: items };
      }

      function loadModels(){
        try{
          var raw = localStorage.getItem(STORAGE_KEY);
          if(!raw){ return JSON.parse(JSON.stringify(DEFAULT_MODELS)); }
          var obj = JSON.parse(raw);
          var out = {};
          for(var k in obj){ if(obj.hasOwnProperty(k)) out[k] = normalizeModel(obj[k]); }
          if(Object.keys(out).length === 0){
            out = JSON.parse(JSON.stringify(DEFAULT_MODELS));
          }
          return out;
        }catch(e){
          showStatus('Errore caricamento modelli: '+e.message+'\nRipristino i modelli di base.');
          return JSON.parse(JSON.stringify(DEFAULT_MODELS));
        }
      }

      function saveModels(models){
        try{
          localStorage.setItem(STORAGE_KEY, JSON.stringify(models));
        }catch(e){
          showStatus('Errore salvataggio: '+e.message);
        }
      }

      var MODELS = loadModels();

      var $ = function(id){ return document.getElementById(id); };
      var modelSel = $('model');

      function refreshModelOptions(selectName){
        modelSel.innerHTML = '';
        for(var k in MODELS){
          if(MODELS.hasOwnProperty(k)){
            var o = document.createElement('option');
            o.value = k; o.textContent = k;
            modelSel.appendChild(o);
          }
        }
        if(selectName && MODELS[selectName]){
          modelSel.value = selectName;
        }else if(!modelSel.value){
          var first = Object.keys(MODELS)[0];
          modelSel.value = first;
        }
      }

      function renderEditor(name){
        $('modelBadge').textContent = name;
        var editor = $('editor');
        editor.innerHTML = '';
        var m = MODELS[name];
        if(!m){ return; }
        if(!m.items) m.items = [];
        for(var i=0;i<m.items.length;i++){
          (function(idx){
            var item = m.items[idx] || {label:'',expr:''};
            var row = document.createElement('div');
            row.className = 'editor-row';
            row.innerHTML =
              '<input placeholder="Nome riga" value="'+(item.label||'')+'" data-idx="'+idx+'" data-field="label"/>' +
              '<input placeholder="Formula (es. L - 12)" value="'+(item.expr||'')+'" data-idx="'+idx+'" data-field="expr"/>' +
              '<div style="display:flex;gap:6px;justify-content:flex-end">' +
                '<button class="icon-btn" title="Sposta su" data-idx="'+idx+'" data-action="up">↑</button>' +
                '<button class="icon-btn" title="Sposta giù" data-idx="'+idx+'" data-action="down">↓</button>' +
                '<button class="icon-btn" title="Elimina" data-idx="'+idx+'" data-action="del">🗑</button>' +
              '</div>';
            editor.appendChild(row);
          })(i);
        }
        var ups = editor.querySelectorAll('[data-action="up"]');
        for(var u=0;u<ups.length;u++){ if(u===0) ups[u].disabled = true; }
        var downs = editor.querySelectorAll('[data-action="down"]');
        for(var d=0;d<downs.length;d++){ if(d===downs.length-1) downs[d].disabled = true; }
      }

      function loadModel(name){ renderEditor(name); }

      modelSel.addEventListener('change', function(e){ loadModel(e.target.value); });
      refreshModelOptions('MAGIKA'); loadModel('MAGIKA'); clearStatus();

      // Editor: input
      $('editor').addEventListener('input', function(e){
        var t = e.target;
        if(t.tagName !== 'INPUT') return;
        var idx = Number(t.getAttribute('data-idx'));
        var field = t.getAttribute('data-field');
        var name = modelSel.value;
        if(!MODELS[name].items[idx]) MODELS[name].items[idx] = {label:'',expr:''};
        MODELS[name].items[idx][field] = t.value;
      });

      // Editor: pulsanti riga
      $('editor').addEventListener('click', function(e){
        var t = e.target;
        var name = modelSel.value;
        if(!name) return;
        var action = t.getAttribute('data-action');
        if(action === 'del'){
          var idx = Number(t.getAttribute('data-idx'));
          MODELS[name].items.splice(idx,1);
          renderEditor(name);
        }
        if(action === 'up'){
          var idxU = Number(t.getAttribute('data-idx'));
          var arrU = MODELS[name].items;
          if(idxU>0){
            var tmpU = arrU[idxU-1]; arrU[idxU-1] = arrU[idxU]; arrU[idxU] = tmpU;
            renderEditor(name);
          }
        }
        if(action === 'down'){
          var idxD = Number(t.getAttribute('data-idx'));
          var arrD = MODELS[name].items;
          if(idxD < arrD.length-1){
            var tmpD = arrD[idxD+1]; arrD[idxD+1] = arrD[idxD]; arrD[idxD] = tmpD;
            renderEditor(name);
          }
        }
      });

      // Aggiungi riga
      $('addRow').addEventListener('click', function(){
        var name = modelSel.value;
        if(!name){ showStatus('Seleziona o crea un modello prima.'); return; }
        MODELS[name].items.push({label:'',expr:''});
        renderEditor(name);
      });

      // Calcolo
      function safeEval(expr, L, H){
        if(/[^0-9+\-*/(). LHl]/.test(expr)) throw new Error('Caratteri non consentiti in formula');
        var fn = new Function('L','H','return ('+expr+');');
        var v = fn(L,H);
        if(typeof v!=='number' || !isFinite(v)) throw new Error('Formula non valida');
        return v;
      }
      function fmt(n,u){ return (Math.round(n*100)/100)+' '+u; }
      var unit = 'cm';

      $('calc').addEventListener('click', function(){
        clearStatus();
        var L = Number($('L').value), H = Number($('H').value);
        if(!(L>0 && H>0)){
          $('out').innerHTML = '<tr><td colspan="3" class="muted">Valori non validi. Inserisci L e H.</td></tr>';
          return;
        }
        var m = MODELS[modelSel.value];
        var items = m && m.items ? m.items : [];
        if(items.length===0){
          $('out').innerHTML = '<tr><td colspan="3" class="muted">Nessuna riga definita per questo modello. Aggiungine una in Avanzate.</td></tr>';
          return;
        }
        var rows = [];
        for(var i=0;i<items.length;i++){
          var it = items[i];
          if(!it.expr){
            rows.push('<tr><td>'+(it.label||'')+'</td><td class="muted"></td><td class="muted">—</td></tr>');
            continue;
          }
          try{
            var res = safeEval(it.expr, L, H);
            rows.push('<tr><td>'+(it.label||'')+'</td><td class="muted">'+it.expr+'</td><td><b>'+fmt(res,unit)+'</b></td></tr>');
          }catch(err){
            rows.push('<tr><td>'+(it.label||'')+'</td><td class="muted">'+it.expr+'</td><td class="muted">Errore: '+err.message+'</td></tr>');
          }
        }
        $('out').innerHTML = rows.join('');
      });

      $('reset').addEventListener('click', function(){
        $('L').value = ''; $('H').value = '';
        $('out').innerHTML = '<tr><td colspan="3" class="muted">Inserisci L e H e premi Calcola.</td></tr>';
      });

      // Salva/Export/Import
      $('save').addEventListener('click', function(){
        saveModels(MODELS);
        showStatus('Modelli salvati.');
        setTimeout(clearStatus, 1500);
      });

      $('exportModels').addEventListener('click', function (){
        try{
          var blob = new Blob([JSON.stringify(MODELS, null, 2)], {type: 'application/json'});
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url; a.download = 'modelli-tende-cm.json';
          document.body.appendChild(a); a.click(); a.remove();
          setTimeout(function(){ URL.revokeObjectURL(url); }, 1500);
          clearStatus();
        }catch(err){ showStatus('Errore export: '+err.message); }
      });

      $('importFile').addEventListener('change', function(e){
        var file = e.target.files[0];
        if(!file) return;
        var reader = new FileReader();
        reader.onload = function(){
          try{
            var imported = JSON.parse(reader.result);
            if(!imported || typeof imported !== 'object') throw new Error('Formato non valido');
            var out = {};
            for(var k in imported){ if(imported.hasOwnProperty(k)) out[k] = normalizeModel(imported[k]); }
            if(Object.keys(out).length === 0){
              out = JSON.parse(JSON.stringify(DEFAULT_MODELS));
            }
            MODELS = out;
            saveModels(MODELS);
            var pick = Object.keys(MODELS)[0];
            refreshModelOptions(pick);
            loadModel(pick);
            showStatus('Modelli importati con successo.');
          }catch(err){
            showStatus('Errore import: '+err.message);
          }
        };
        reader.readAsText(file);
        e.target.value = '';
      });

      // Gestione modelli
      document.getElementById('btnAddModel').addEventListener('click', function(){
        try{
          var base = modelSel.value || Object.keys(MODELS)[0];
          var name = prompt('Nome del nuovo modello (es. SPACE, MODULINA, BQ220):');
          if(!name) return;
          name = name.trim();
          if(!name) return;
          if(MODELS[name]){ showStatus('Esiste già un modello con questo nome.'); return; }
          var src = MODELS[base] || {items:[]};
          MODELS[name] = JSON.parse(JSON.stringify(src));
          saveModels(MODELS);
          refreshModelOptions(name);
          loadModel(name);
          clearStatus();
        }catch(err){
          showStatus('Errore durante la creazione del modello: '+err.message);
        }
      });

      document.getElementById('btnDeleteModel').addEventListener('click', function(){
        var name = modelSel.value;
        if(!name) return;
        var keys = Object.keys(MODELS);
        if(keys.length <= 1){
          showStatus('Deve esistere almeno un modello.');
          return;
        }
        if(confirm('Eliminare il modello "'+name+'"?')){
          delete MODELS[name];
          saveModels(MODELS);
          var pick = Object.keys(MODELS)[0];
          refreshModelOptions(pick);
          loadModel(pick);
          clearStatus();
        }
      });

    })();
  </script>
</body>
</html>
